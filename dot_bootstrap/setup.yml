---
- name: Machine setup
  hosts: localhost
  become: true
  connection: local
  gather_facts: true

  tasks:
    - name: Get my user
      ansible.builtin.set_fact:
        remote_regular_user: "{{ ansible_env.SUDO_USER or ansible_user_id }}"

    - name: Create the `aur_builder` user
      become: yes
      ansible.builtin.user:
        name: aur_builder
        create_home: yes
        group: wheel

    - name: Allow the `aur_builder` user to run `sudo pacman` without a password
      become: yes
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/11-install-aur_builder
        line: 'aur_builder ALL=(ALL) NOPASSWD: /usr/bin/pacman'
        create: yes
        mode: 0644
        validate: 'visudo -cf %s'

    - name: Change shell to zsh
      ansible.builtin.user:
        name: "{{ remote_regular_user }}"
        shell: /usr/bin/zsh

    - name: Install essencial apps using yay
      kewlfft.aur.aur:
        use: yay
        name:
          - librewolf-bin
          - fastfetch
          - rofi-wayland
          - swww
          - flatpak
          - mpv
          - aria2
          - yt-dlp
          - yt-dlp-ejs
          - qbittorrent
          - fcitx5
          - fcitx5-qt
          - fcitx5-mozc-ut
      become: yes
      become_user: aur_builder

    - name: Install essencial apps with Flatpak
      community.general.flatpak:
        name:
          - org.mozilla.Thunderbird
        state: present

    - name: Install media apps using yay
      kewlfft.aur.aur:
        use: yay
        name:
          - ffmpeg
          - imagemagick
          - makemkv
          - whipper
      become: yes
      become_user: aur_builder

    - name: Install media apps with Flatpak
      community.general.flatpak:
        name:
          - com.github.iwalton3.jellyfin-media-player
        state: present

    - name: Install art apps using yay
      kewlfft.aur.aur:
        use: yay
        name:
          - aseprite
          - lmms
          - mpd
          - rmpc
      become: yes
      become_user: aur_builder

    - name: Install art apps with Flatpak
      community.general.flatpak:
        name:
          - org.gimp.GIMP
          - com.obsproject.Studio
          - org.kde.kdenlive
          - org.tenacityaudio.Tenacity
          - org.kde.krita
          - org.inkscape.Inkscape
          - org.blender.Blender
          - org.darktable.Darktable
        state: present

    - name: Install privacy apps using yay
      kewlfft.aur.aur:
        use: yay
        name:
          - mullvad-browser-bin
          - veracrypt
          - keepassxc
      become: yes
      become_user: aur_builder

    - name: Install privacy apps with Flatpak
      community.general.flatpak:
        name:
          - org.torproject.torbrowser-launcher
        state: present

    - name: Install dev tools using yay
      kewlfft.aur.aur:
        use: yay
        name:
          - vscodium-bin
          - vscodium-marketplace
          - scrcpy
          - gnupg
      become: yes
      become_user: aur_builder

    - name: Add the Dolphin Emulator flatpak remote to the system
      community.general.flatpak_remote:
        name: dolphin-emu
        flatpakrepo_url: https://flatpak.dolphin-emu.org/releases.flatpakrepo
        state: present
    
    - name: Install Dolphin Emulator
      community.general.flatpak:
        name: org.DolphinEmu.dolphin-emu
        remote: dolphin-emu
        state: present

    - name: Install emulators using yay
      kewlfft.aur.aur:
        use: yay
        name:
          - rpcs3-bin
          - cemu
          - shadps4-git
          - vita3k-git
          - eden
      become: yes
      become_user: aur_builder

    - name: Install emulators with Flatpak
      community.general.flatpak:
        name:
          - net.pcsx2.PCSX2
          - org.duckstation.DuckStation
          - org.ppsspp.PPSSPP
        state: present

    - name: Install gaming apps using yay
      kewlfft.aur.aur:
        use: yay
        name:
          - freesmlauncher
          - osu-lazer-bin
          - emulationstation-de
          - steam
          - lutris
      become: yes
      become_user: aur_builder

    - name: Install gaming apps with Flatpak
      community.general.flatpak:
        name:
          - com.fightcade.Fightcade
          - net.lutris.Lutris
          - com.feaneron.Boatswain
          - org.vinegarhq.Sober
          - io.github.marco_calautti.DeltaPatcher
        state: present

    - name: Install writing tools using yay
      kewlfft.aur.aur:
        use: yay
        name:
          - obsidian-appimage
          - typst
      become: yes
      become_user: aur_builder

    - name: Get installed VSCodium extensions
      ansible.builtin.command: codium --list-extensions
      register: codium_extensions
      changed_when: false

    - name: Install missing VSCodium extensions
      ansible.builtin.command: codium --install-extension {{ item }}
      loop:
        - ms-python.python
        - esbenp.prettier-vscode
        - vscode-icons-team.vscode-icons
        - dracula-theme.theme-dracula
        - formulahendry.code-runner
        - mathematic.vscode-pdf
        - myriad-dreamin.tinymist
      when: item not in codium_extensions.stdout_lines

    - name: Ensure fonts directory
      ansible.builtin.file:
        path: "/home/{{ remote_regular_user }}/.fonts"
        state: directory
        mode: "0755"
        owner: "{{ remote_regular_user }}"

    - name: Check if JetBrains Mono exists
      ansible.builtin.shell: "ls /home/{{ remote_regular_user }}/.fonts/JetBrainsMonoNerd*FontMono*"
      register: jetbrains_mono_exists
      changed_when: false

    - name: Download JetBrains Mono
      when: jetbrains_mono_exists is failed
      ansible.builtin.unarchive:
        src: https://github.com/ryanoasis/nerd-fonts/releases/download/v3.4.0/JetBrainsMono.zip
        dest: "/home/{{ remote_regular_user }}/.fonts/"
        remote_src: true
        mode: "0755"
        owner: "{{ remote_regular_user }}"

    - name: Check if Batcher plugin exists in GIMP
      ansible.builtin.shell: "ls /home/{{ remote_regular_user }}/.config/GIMP/plug-ins/batcher"
      register: batcher_plugin_exists
      changed_when: false

    - name: Download Batcher plguin
      when: batcher_plugin_exists is failed
      ansible.builtin.unarchive:
        src: https://github.com/kamilburda/batcher/releases/download/1.1.1/batcher-1.1.1.zip
        dest: "/home/{{ remote_regular_user }}/.config/GIMP/plug-ins/"
        remote_src: true
        mode: "0755"
        owner: "{{ remote_regular_user }}"

    - name: Check if FC2JSON files exists
      ansible.builtin.find:
        paths: "/home/{{ remote_regular_user }}/.local/share/flatpak/fightcade/emulator"
        patterns: "*.json"
        file_type: file
      register: fc2json_files

    - name: Download FC2JSON
      when: fc2json_files.matched == 0
      ansible.builtin.unarchive:
        src: https://fightcade.download/fc2json.zip
        dest: "/home/{{ remote_regular_user }}/.local/share/flatpak/fightcade/emulator/"
        remote_src: true
        mode: "0755"
        owner: "{{ remote_regular_user }}"

    - name: Remove unnecessary packages using yay
      kewlfft.aur.aur:
        use: yay
        state: absent
        name:
          - firefox
      become: yes
      become_user: aur_builder
